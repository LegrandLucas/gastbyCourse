{"version":3,"sources":["../../src/utils/start-server.ts"],"names":["startServer","program","app","workerPool","WorkerPool","create","directory","webpackActivity","report","activityTimer","id","start","directoryPath","buildHTML","require","createIndexHtml","activity","stage","Stage","DevelopHTML","pagePaths","err","name","panic","stripIndent","indexHTMLActivity","phantomActivity","process","env","GATSBY_EXPERIMENTAL_DEV_SSR","buildRenderer","initDevWorkerPool","end","TWENTY_SECONDS","cancelDevJSNotice","gatsby_executing_command","GATSBY_EXPERIMENTAL_LAZY_DEVJS","devConfig","port","parentSpan","span","compiler","bodyParser","boundActionCreators","createClientVisitedPage","chunkCalls","Set","post","json","req","res","next","body","chunkName","has","setTimeout","pages","store","getState","getByChunkName","map","searchValue","key","value","entries","componentChunkName","undefined","pageKey","page","get","dispatch","type","payload","componentPath","component","add","send","use","telemetry","expressMiddleware","log","path","heartbeat","graphqlEndpoint","GATSBY_GRAPHQL_IDE","endpoint","schema","schemaCustomization","composer","Error","graphiql","extensions","enableRefresh","ENABLE_GATSBY_REFRESH_ENDPOINT","refreshToken","GATSBY_REFRESH_TOKEN","context","schemaComposer","customContext","customFormatErrorFn","stack","split","REFRESH_ENDPOINT","refresh","emitter","emit","webhookBody","express","authorizedRefresh","headers","authorization","query","fileName","lineNumber","requestedPagePath","params","pagePath","potentialPagePath","pageData","GATSBY_EXPERIMENTAL_QUERY_ON_DEMAND","join","status","e","error","index","webpackDevMiddlewareInstance","logLevel","publicPath","output","watchOptions","devServer","stats","developMiddleware","config","proxy","forEach","prefix","url","proxiedUrl","originalUrl","host","method","pipe","got","stream","decompress","on","response","writeHead","statusCode","_","message","sendStatus","deferNodeMutation","route","fullUrl","protocol","endsWith","webpackCompilationHash","renderDevHTML","renderResponse","htmlComponentRendererPath","sendFile","server","http","Server","socket","websocketManager","init","listener","listen","chokidar","slash","watchGlobs","watch","to","webpackWatching","watching"],"mappings":";;;;;;;;;AAAA;;AACA;;AAGA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AAEA;;AACA;;AACA;;AACA;;AAEA;;AACA;;AACA;;AACA;;AACA;;AACA;;AAKA;;AACA;;AACA;;AACA;;AAKA;;AACA;;AACA;;AAEA;;AAEA;;AA6BO,eAAeA,WAAf,CACLC,OADK,EAELC,GAFK,EAGLC,UAAsB,GAAGC,UAAU,CAACC,MAAX,EAHpB,EAIa;AAClB,QAAMC,SAAS,GAAGL,OAAO,CAACK,SAA1B;;AAEA,QAAMC,eAAe,GAAGC,kBAAOC,aAAP,CAAsB,6BAAtB,EAAoD;AAC1EC,IAAAA,EAAE,EAAG;AADqE,GAApD,CAAxB;;AAGAH,EAAAA,eAAe,CAACI,KAAhB,GANkB,CAQlB;;AACA,QAAMC,aAAa,GAAG,wBAAaN,SAAb,CAAtB;;AACA,QAAM;AAAEO,IAAAA;AAAF,MAAgBC,OAAO,CAAE,wBAAF,CAA7B;;AACA,QAAMC,eAAe,GAAG,MAAOC,QAAP,IAAoD;AAC1E,QAAI;AACF,YAAMH,SAAS,CAAC;AACdZ,QAAAA,OADc;AAEdgB,QAAAA,KAAK,EAAEC,aAAMC,WAFC;AAGdC,QAAAA,SAAS,EAAE,CAAE,GAAF,CAHG;AAIdjB,QAAAA,UAJc;AAKda,QAAAA;AALc,OAAD,CAAf;AAOD,KARD,CAQE,OAAOK,GAAP,EAAY;AACZ,UAAIA,GAAG,CAACC,IAAJ,KAAc,cAAlB,EAAiC;AAC/Bd,0BAAOe,KAAP,CAAaF,GAAb;;AACA;AACD;;AACDb,wBAAOe,KAAP,CACEf,kBAAOgB,WAAY;AAC3B;AACA;AACA,SAJM,EAKEH,GALF;AAOD;AACF,GAtBD;;AAuBA,QAAMI,iBAAiB,GAAGjB,kBAAOkB,eAAP,CAAwB,qBAAxB,EAA8C,EAA9C,CAA1B;;AAEA,MAAIC,OAAO,CAACC,GAAR,CAAYC,2BAAhB,EAA6C;AAC3C,UAAM;AAAEC,MAAAA;AAAF,QAAoBhB,OAAO,CAAE,wBAAF,CAAjC;;AACA,UAAMgB,aAAa,CAAC7B,OAAD,EAAUiB,aAAMC,WAAhB,CAAnB;;AACA,UAAM;AAAEY,MAAAA;AAAF,QAAwBjB,OAAO,CAAE,2BAAF,CAArC;;AACAiB,IAAAA,iBAAiB;AAClB,GALD,MAKO;AACLN,IAAAA,iBAAiB,CAACd,KAAlB;AAEA,UAAMI,eAAe,CAACU,iBAAD,CAArB;AAEAA,IAAAA,iBAAiB,CAACO,GAAlB;AACD;;AAED,QAAMC,cAAc,GAAG,KAAK,IAA5B;AACA,MAAIC,iBAAJ;;AACA,MACEP,OAAO,CAACC,GAAR,CAAYO,wBAAZ,KAA0C,SAA1C,IACA,CAACR,OAAO,CAACC,GAAR,CAAYQ,8BADb,IAEA,CAAC,4BAHH,EAIE;AACAF,IAAAA,iBAAiB,GAAG,4DACjB,YADiB,EAElB1B,kBAAOgB,WAAP,CAAoB;AAC1B;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAVM,CAFkB,EAalBS,cAbkB,CAApB;AAeD;;AAED,QAAMI,SAAS,GAAG,MAAM,uBACtBpC,OADsB,EAEtBK,SAFsB,EAGrB,SAHqB,EAItBL,OAAO,CAACqC,IAJc,EAKtB;AAAEC,IAAAA,UAAU,EAAEhC,eAAe,CAACiC;AAA9B,GALsB,CAAxB;AAQA,QAAMC,QAAQ,GAAG,sBAAQJ,SAAR,CAAjB;;AAEA,MAAIV,OAAO,CAACC,GAAR,CAAYQ,8BAAhB,EAAgD;AAC9C,UAAMM,UAAU,GAAG5B,OAAO,CAAE,aAAF,CAA1B;;AACA,UAAM;AAAE6B,MAAAA;AAAF,QAA0B7B,OAAO,CAAE,kBAAF,CAAvC;;AACA,UAAM;AAAE8B,MAAAA;AAAF,QAA8BD,mBAApC,CAH8C,CAI9C;AACA;;AACA,UAAME,UAAU,GAAG,IAAIC,GAAJ,EAAnB;AACA5C,IAAAA,GAAG,CAAC6C,IAAJ,CAAU,yBAAV,EAAoCL,UAAU,CAACM,IAAX,EAApC,EAAuD,CAACC,GAAD,EAAMC,GAAN,EAAWC,IAAX,KAAoB;AAAA;;AACzE,uBAAIF,GAAG,CAACG,IAAR,8CAAI,UAAUC,SAAd,EAAyB;AACvB;AACA,YAAI,CAACR,UAAU,CAACS,GAAX,CAAeL,GAAG,CAACG,IAAJ,CAASC,SAAxB,CAAL,EAAyC;AACvC;AACA;AACAT,UAAAA,uBAAuB,CAACK,GAAG,CAACG,IAAJ,CAASC,SAAV,CAAvB,CAHuC,CAKvC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AACAE,UAAAA,UAAU,CAAC,MAAM;AACf;AACA,kBAAMC,KAAK,GAAGC,aAAMC,QAAN,GAAiBF,KAA/B;;AACA,qBAASG,cAAT,CAAwBC,GAAxB,EAA6BC,WAA7B,EAAyD;AACvD,mBAAK,MAAM,CAACC,GAAD,EAAMC,KAAN,CAAX,IAA2BH,GAAG,CAACI,OAAJ,EAA3B,EAA0C;AACxC,oBAAID,KAAK,CAACE,kBAAN,KAA6BJ,WAAjC,EAA8C,OAAOC,GAAP;AAC/C;;AAED,qBAAOI,SAAP;AACD;;AACD,kBAAMC,OAAO,GAAGR,cAAc,CAACH,KAAD,EAAQP,GAAG,CAACG,IAAJ,CAASC,SAAjB,CAA9B;;AAEA,gBAAIc,OAAJ,EAAa;AACX,oBAAMC,IAAI,GAAGZ,KAAK,CAACa,GAAN,CAAUF,OAAV,CAAb;;AACA,kBAAIC,IAAJ,EAAU;AACRX,6BAAMa,QAAN,CAAe;AACbC,kBAAAA,IAAI,EAAG,iCADM;AAEbC,kBAAAA,OAAO,EAAE;AACPhB,oBAAAA,KAAK,EAAE,CACL;AACEiB,sBAAAA,aAAa,EAAEL,IAAI,CAACM;AADtB,qBADK;AADA;AAFI,iBAAf;AAUD;AACF;;AACD7B,YAAAA,UAAU,CAAC8B,GAAX,CAAe1B,GAAG,CAACG,IAAJ,CAASC,SAAxB;AACD,WA5BS,EA4BP,EA5BO,CAAV;AA6BD;;AACDH,QAAAA,GAAG,CAAC0B,IAAJ,CAAU,IAAV;AACD,OA9CD,MA8CO;AACLzB,QAAAA,IAAI;AACL;AACF,KAlDD;AAmDD;AAED;AACF;AACA;;;AACEjD,EAAAA,GAAG,CAAC2E,GAAJ,CAAQ,2BAAR;AACA3E,EAAAA,GAAG,CAAC2E,GAAJ,CAAQC,yBAAUC,iBAAV,CAA6B,SAA7B,CAAR;AACA7E,EAAAA,GAAG,CAAC2E,GAAJ,CACE,mCAAqBpC,QAArB,EAA+B;AAC7BuC,IAAAA,GAAG,EAAE,KADwB;AAE7BC,IAAAA,IAAI,EAAG,gBAFsB;AAG7BC,IAAAA,SAAS,EAAE,KAAK;AAHa,GAA/B,CADF;AAQAhF,EAAAA,GAAG,CAAC2E,GAAJ,CAAQ,oBAAR;AAEA;AACF;AACA;;AACE,QAAMM,eAAe,GAAI,cAAzB;;AAEA,MAAIxD,OAAO,CAACC,GAAR,CAAYwD,kBAAZ,KAAoC,YAAxC,EAAqD;AACnDlF,IAAAA,GAAG,CAACmE,GAAJ,CACEc,eADF,EAEE,iDAAkB;AAChBE,MAAAA,QAAQ,EAAG;AADK,KAAlB,CAFF,EAKE,MAAM,CAAE,CALV;AAOD,GARD,MAQO;AACL,yCAAiBnF,GAAjB,EAAsB;AACpBiF,MAAAA;AADoB,KAAtB;AAGD;;AAEDjF,EAAAA,GAAG,CAAC2E,GAAJ,CACEM,eADF,EAEE,6BACE,MAA+B;AAC7B,UAAM;AAAEG,MAAAA,MAAF;AAAUC,MAAAA;AAAV,QAAkC9B,aAAMC,QAAN,EAAxC;;AAEA,QAAI,CAAC6B,mBAAmB,CAACC,QAAzB,EAAmC;AACjC,YAAM,IAAIC,KAAJ,CACH,yHADG,CAAN;AAGD;;AACD,WAAO;AACLH,MAAAA,MADK;AAELI,MAAAA,QAAQ,EAAE,KAFL;;AAGLC,MAAAA,UAAU,GAA+B;AACvC,eAAO;AACLC,UAAAA,aAAa,EAAEjE,OAAO,CAACC,GAAR,CAAYiE,8BADtB;AAELC,UAAAA,YAAY,EAAEnE,OAAO,CAACC,GAAR,CAAYmE;AAFrB,SAAP;AAID,OARI;;AASLC,MAAAA,OAAO,EAAE,sBAAoB;AAC3BV,QAAAA,MAD2B;AAE3BW,QAAAA,cAAc,EAAEV,mBAAmB,CAACC,QAFT;AAG3BQ,QAAAA,OAAO,EAAE,EAHkB;AAI3BE,QAAAA,aAAa,EAAEX,mBAAmB,CAACS;AAJR,OAApB,CATJ;;AAeLG,MAAAA,mBAAmB,CAAC9E,GAAD,EAAe;AAChC,eAAO,EACL,GAAG,0BAAYA,GAAZ,CADE;AAEL+E,UAAAA,KAAK,EAAE/E,GAAG,CAAC+E,KAAJ,GAAY/E,GAAG,CAAC+E,KAAJ,CAAUC,KAAV,CAAiB,IAAjB,CAAZ,GAAoC;AAFtC,SAAP;AAID;;AApBI,KAAP;AAsBD,GA/BH,CAFF;AAqCA;AACF;AACA;AACA;AACA;;AACE,QAAMC,gBAAgB,GAAI,YAA1B;;AACA,QAAMC,OAAO,GAAG,MAAOtD,GAAP,IAA+C;AAC7DuD,mBAAQC,IAAR,CAAc,kBAAd,EAAiC;AAC/BC,MAAAA,WAAW,EAAEzD,GAAG,CAACG;AADc,KAAjC;AAGD,GAJD;;AAKAlD,EAAAA,GAAG,CAAC2E,GAAJ,CAAQyB,gBAAR,EAA0BK,iBAAQ3D,IAAR,EAA1B;AACA9C,EAAAA,GAAG,CAAC6C,IAAJ,CAASuD,gBAAT,EAA2B,CAACrD,GAAD,EAAMC,GAAN,KAAc;AACvC,UAAM0C,aAAa,GAAGjE,OAAO,CAACC,GAAR,CAAYiE,8BAAlC;AACA,UAAMC,YAAY,GAAGnE,OAAO,CAACC,GAAR,CAAYmE,oBAAjC;AACA,UAAMa,iBAAiB,GACrB,CAACd,YAAD,IAAiB7C,GAAG,CAAC4D,OAAJ,CAAYC,aAAZ,KAA8BhB,YADjD;;AAGA,QAAIF,aAAa,IAAIgB,iBAArB,EAAwC;AACtCL,MAAAA,OAAO,CAACtD,GAAD,CAAP;AACD;;AACDC,IAAAA,GAAG,CAAClB,GAAJ;AACD,GAVD;AAYA9B,EAAAA,GAAG,CAACmE,GAAJ,CAAS,+BAAT,EAAyC,CAACpB,GAAD,EAAMC,GAAN,KAAc;AACrD,+BAAaD,GAAG,CAAC8D,KAAJ,CAAUC,QAAvB,EAAiC/D,GAAG,CAAC8D,KAAJ,CAAUE,UAA3C;AACA/D,IAAAA,GAAG,CAAClB,GAAJ;AACD,GAHD;AAKA9B,EAAAA,GAAG,CAACmE,GAAJ,CACG,wCADH,EAEE,OAAOpB,GAAP,EAAYC,GAAZ,EAAiBC,IAAjB,KAAyC;AACvC,UAAM+D,iBAAiB,GAAGjE,GAAG,CAACkE,MAAJ,CAAWC,QAArC;;AACA,QAAI,CAACF,iBAAL,EAAwB;AACtB/D,MAAAA,IAAI;AACJ;AACD;;AAED,UAAMkE,iBAAiB,GAAG,oCAAqBH,iBAArB,CAA1B;AACA,UAAM9C,IAAI,GAAG,oCAAeX,aAAMC,QAAN,EAAf,EAAiC2D,iBAAjC,EAAoD,KAApD,CAAb;;AAEA,QAAIjD,IAAJ,EAAU;AACR,UAAI;AACF,cAAMkD,QAAkC,GAAG3F,OAAO,CAACC,GAAR,CACxC2F,mCADwC,GAEvC,MAAM,8BAAwBnD,IAAI,CAACa,IAA7B,CAFiC,GAGvC,MAAM,4BACJA,IAAI,CAACuC,IAAL,CAAU/D,aAAMC,QAAN,GAAiBzD,OAAjB,CAAyBK,SAAnC,EAA+C,QAA/C,CADI,EAEJ8D,IAAI,CAACa,IAFD,CAHV;AAQA/B,QAAAA,GAAG,CAACuE,MAAJ,CAAW,GAAX,EAAgB7C,IAAhB,CAAqB0C,QAArB;AACA;AACD,OAXD,CAWE,OAAOI,CAAP,EAAU;AACVlH,0BAAOmH,KAAP,CACG,iDAAgDT,iBAAkB,QAAOG,iBAAkB,sDAD9F,EAEEK,CAFF;AAID;AACF;;AAEDxE,IAAAA,GAAG,CAACuE,MAAJ,CAAW,GAAX,EAAgB7C,IAAhB,CAAqB;AACnBK,MAAAA,IAAI,EAAEoC;AADa,KAArB;AAGD,GAnCH,EAnPkB,CAyRlB;AACA;AACA;AACA;;AACAnH,EAAAA,GAAG,CAAC2E,GAAJ,CAAQ,kCAAe,QAAf,EAAwB;AAAE+C,IAAAA,KAAK,EAAE;AAAT,GAAxB,CAAR;AAEA,QAAMC,4BAA4B,GAAI,mCAAqBpF,QAArB,EAA+B;AACnEqF,IAAAA,QAAQ,EAAG,QADwD;AAEnEC,IAAAA,UAAU,EAAE1F,SAAS,CAAC2F,MAAV,CAAiBD,UAFsC;AAGnEE,IAAAA,YAAY,EAAE5F,SAAS,CAAC6F,SAAV,GAAsB7F,SAAS,CAAC6F,SAAV,CAAoBD,YAA1C,GAAyD,IAHJ;AAInEE,IAAAA,KAAK,EAAG;AAJ2D,GAA/B,CAAtC;AAOAjI,EAAAA,GAAG,CAAC2E,GAAJ,CAAQgD,4BAAR,EAtSkB,CAwSlB;;AACA,QAAM;AAAEO,IAAAA;AAAF,MAAwB3E,aAAMC,QAAN,GAAiB2E,MAA/C;;AAEA,MAAID,iBAAJ,EAAuB;AACrBA,IAAAA,iBAAiB,CAAClI,GAAD,EAAMD,OAAN,CAAjB;AACD,GA7SiB,CA+SlB;;;AACA,QAAM;AAAEqI,IAAAA;AAAF,MAAY7E,aAAMC,QAAN,GAAiB2E,MAAnC;;AACA,MAAIC,KAAJ,EAAW;AACTA,IAAAA,KAAK,CAACC,OAAN,CAAc,CAAC;AAAEC,MAAAA,MAAF;AAAUC,MAAAA;AAAV,KAAD,KAAqB;AACjCvI,MAAAA,GAAG,CAAC2E,GAAJ,CAAS,GAAE2D,MAAO,IAAlB,EAAuB,CAACvF,GAAD,EAAMC,GAAN,KAAc;AACnC,cAAMwF,UAAU,GAAGD,GAAG,GAAGxF,GAAG,CAAC0F,WAA7B;AACA,cAAM;AACJ;AACA;AACA9B,UAAAA,OAAO,EAAE;AAAE+B,YAAAA,IAAF;AAAQ,eAAG/B;AAAX,WAHL;AAIJgC,UAAAA;AAJI,YAKF5F,GALJ;AAMAA,QAAAA,GAAG,CACA6F,IADH,CAEIC,aACGC,MADH,CACUN,UADV,EACsB;AAAE7B,UAAAA,OAAF;AAAWgC,UAAAA,MAAX;AAAmBI,UAAAA,UAAU,EAAE;AAA/B,SADtB,EAEGC,EAFH,CAEO,UAFP,EAEkBC,QAAQ,IACtBjG,GAAG,CAACkG,SAAJ,CAAcD,QAAQ,CAACE,UAAT,IAAuB,GAArC,EAA0CF,QAAQ,CAACtC,OAAnD,CAHJ,EAKGqC,EALH,CAKO,OALP,EAKe,CAAC7H,GAAD,EAAMiI,CAAN,EAASH,QAAT,KAAsB;AACjC,cAAIA,QAAJ,EAAc;AACZjG,YAAAA,GAAG,CAACkG,SAAJ,CAAcD,QAAQ,CAACE,UAAT,IAAuB,GAArC,EAA0CF,QAAQ,CAACtC,OAAnD;AACD,WAFD,MAEO;AACL,kBAAM0C,OAAO,GAAI,uCAAsCtG,GAAG,CAAC0F,WAAY,SAAQD,UAAW,GAA1F;;AAEAlI,8BAAOmH,KAAP,CAAa4B,OAAb,EAAsBlI,GAAtB;;AACA6B,YAAAA,GAAG,CAACsG,UAAJ,CAAe,GAAf;AACD;AACF,SAdH,CAFJ,EAkBGV,IAlBH,CAkBQ5F,GAlBR;AAmBD,OA3BD;AA4BD,KA7BD,EA6BG,oBA7BH;AA8BD;;AAED,QAAM,4BAAe,mBAAf,EAAmC;AAAEhD,IAAAA,GAAF;AAAOuJ,IAAAA,iBAAiB,EAAE;AAA1B,GAAnC,CAAN,CAlVkB,CAoVlB;AACA;AACA;AACA;;AACAvJ,EAAAA,GAAG,CAAC2E,GAAJ,CAAQ,wBAAR,EAAkC,CAACyE,CAAD,EAAIpG,GAAJ,KAAY;AAC5CA,IAAAA,GAAG,CAACuE,MAAJ,CAAW,GAAX,EAAgBzF,GAAhB;AACD,GAFD,EAxVkB,CA4VlB;;AACA,MAAIL,OAAO,CAACC,GAAR,CAAYC,2BAAhB,EAA6C;AAC3C;AACA,UAAM;AAAE6H,MAAAA;AAAF,QAAY5I,OAAO,CAAE,8BAAF,CAAzB;;AACA4I,IAAAA,KAAK,CAAC;AAAExJ,MAAAA,GAAF;AAAOD,MAAAA,OAAP;AAAgBwD,MAAAA,KAAK,EAALA;AAAhB,KAAD,CAAL;AACD;;AAEDvD,EAAAA,GAAG,CAAC2E,GAAJ,CAAQ,OAAO5B,GAAP,EAAYC,GAAZ,KAAoB;AAC1B,UAAMyG,OAAO,GAAG1G,GAAG,CAAC2G,QAAJ,GAAgB,KAAhB,GAAuB3G,GAAG,CAACoB,GAAJ,CAAS,MAAT,CAAvB,GAAyCpB,GAAG,CAAC0F,WAA7D,CAD0B,CAE1B;;AACA,QAAIgB,OAAO,CAACE,QAAR,CAAkB,eAAlB,CAAJ,EAAuC;AACrC3G,MAAAA,GAAG,CAACF,IAAJ,CAAS;AAAE8G,QAAAA,sBAAsB,EAAG;AAA3B,OAAT,EADqC,CAErC;AACD,KAHD,MAGO,IAAIH,OAAO,CAACE,QAAR,CAAkB,OAAlB,CAAJ,EAA+B;AACpC3G,MAAAA,GAAG,CAACF,IAAJ,CAAS,EAAT,EAAayE,MAAb,CAAoB,GAApB;AACD,KAFM,MAEA;AACL,UAAI9F,OAAO,CAACC,GAAR,CAAYC,2BAAhB,EAA6C;AAC3C,YAAI;AACF,gBAAM;AAAEkI,YAAAA;AAAF,cAAoBjJ,OAAO,CAAE,2BAAF,CAAjC;;AACA,gBAAMkJ,cAAc,GAAG,MAAMD,aAAa,CAAC;AACzC9E,YAAAA,IAAI,EAAG,gBADkC;AAEzC;AACAb,YAAAA,IAAI,EAAEF,SAHmC;AAIzCT,YAAAA,KAAK,EAALA,YAJyC;AAKzCwG,YAAAA,yBAAyB,EAAG,GAAEhK,OAAO,CAACK,SAAU,wBALP;AAMzCA,YAAAA,SAAS,EAAEL,OAAO,CAACK;AANsB,WAAD,CAA1C;AAQA,gBAAMmH,MAAM,GAAG9F,OAAO,CAACC,GAAR,CAAYC,2BAAZ,GAA0C,GAA1C,GAAgD,GAA/D;AACAqB,UAAAA,GAAG,CAACuE,MAAJ,CAAWA,MAAX,EAAmB7C,IAAnB,CAAwBoF,cAAxB;AACD,SAZD,CAYE,OAAOtC,CAAP,EAAU;AACVlH,4BAAOmH,KAAP,CAAaD,CAAb;;AACAxE,UAAAA,GAAG,CAAC0B,IAAJ,CAAS8C,CAAT,EAAYD,MAAZ,CAAmB,GAAnB;AACD;AACF,OAjBD,MAiBO;AACLvE,QAAAA,GAAG,CAACgH,QAAJ,CAAatJ,aAAa,CAAE,mBAAF,CAA1B,EAAiDS,GAAG,IAAI;AACtD,cAAIA,GAAJ,EAAS;AACP6B,YAAAA,GAAG,CAACuE,MAAJ,CAAW,GAAX,EAAgBzF,GAAhB;AACD;AACF,SAJD;AAKD;AACF;AACF,GAlCD;AAoCA;AACF;AACA;;AACE,QAAMmI,MAAM,GAAG,IAAIC,cAAKC,MAAT,CAAgBnK,GAAhB,CAAf;;AAEA,QAAMoK,MAAM,GAAGC,mCAAiBC,IAAjB,CAAsB;AAAEL,IAAAA;AAAF,GAAtB,CAAf,CA5YkB,CA8YlB;AACA;;;AACA,QAAMM,QAAQ,GAAGN,MAAM,CAACO,MAAP,CAAczK,OAAO,CAACqC,IAAtB,EAA6B,WAA7B,CAAjB;;AAEA,MAAI,CAACX,OAAO,CAACC,GAAR,CAAYC,2BAAjB,EAA8C;AAC5C,UAAM8I,QAAQ,GAAG7J,OAAO,CAAE,UAAF,CAAxB;;AACA,UAAM;AAAE8J,MAAAA;AAAF,QAAY9J,OAAO,CAAE,mBAAF,CAAzB,CAF4C,CAG5C;;;AACA,UAAM+J,UAAU,GAAG,CAAE,aAAF,EAAiB,0BAAjB,EAA4CjH,GAA5C,CAAgDqB,IAAI,IACrE2F,KAAK,CAAChK,aAAa,CAACqE,IAAD,CAAd,CADY,CAAnB;AAIA0F,IAAAA,QAAQ,CAACG,KAAT,CAAeD,UAAf,EAA2B3B,EAA3B,CAA+B,QAA/B,EAAwC,YAAY;AAClD,YAAMnI,eAAe,CAACU,iBAAD,CAArB,CADkD,CAElD;;AACA6I,MAAAA,MAAM,SAAN,IAAAA,MAAM,WAAN,YAAAA,MAAM,CAAES,EAAR,CAAY,SAAZ,EAAsBtE,IAAtB,CAA4B,QAA5B;AACD,KAJD;AAKD;;AAED,SAAO;AACLhE,IAAAA,QADK;AAELgI,IAAAA,QAFK;AAGLlK,IAAAA,eAHK;AAIL2B,IAAAA,iBAJK;AAKLqI,IAAAA,gBAAgB,EAAhBA,kCALK;AAMLpK,IAAAA,UANK;AAOL6K,IAAAA,eAAe,EAAEnD,4BAA4B,CAAC7B,OAA7B,CAAqCiF;AAPjD,GAAP;AASD","sourcesContent":["import webpackHotMiddleware from \"webpack-hot-middleware\"\nimport webpackDevMiddleware, {\n  WebpackDevMiddleware,\n} from \"webpack-dev-middleware\"\nimport got from \"got\"\nimport webpack from \"webpack\"\nimport express from \"express\"\nimport compression from \"compression\"\nimport graphqlHTTP from \"express-graphql\"\nimport graphqlPlayground from \"graphql-playground-middleware-express\"\nimport graphiqlExplorer from \"gatsby-graphiql-explorer\"\nimport { formatError } from \"graphql\"\nimport http from \"http\"\nimport https from \"https\"\nimport cors from \"cors\"\nimport telemetry from \"gatsby-telemetry\"\nimport launchEditor from \"react-dev-utils/launchEditor\"\nimport { isCI } from \"gatsby-core-utils\"\n\nimport { withBasePath } from \"../utils/path\"\nimport webpackConfig from \"../utils/webpack.config\"\nimport { store, emitter } from \"../redux\"\nimport report from \"gatsby-cli/lib/reporter\"\nimport * as WorkerPool from \"../utils/worker/pool\"\nimport {\n  showExperimentNoticeAfterTimeout,\n  CancelExperimentNoticeCallbackOrUndefined,\n} from \"../utils/show-experiment-notice\"\n\nimport { developStatic } from \"../commands/develop-static\"\nimport withResolverContext from \"../schema/context\"\nimport { websocketManager, WebsocketManager } from \"../utils/websocket-manager\"\nimport {\n  reverseFixedPagePath,\n  readPageData,\n  IPageDataWithQueryResult,\n} from \"./page-data\"\nimport { getPageData as getPageDataExperimental } from \"./get-page-data\"\nimport { findPageByPath } from \"./find-page-by-path\"\nimport apiRunnerNode from \"../utils/api-runner-node\"\nimport { Express } from \"express\"\nimport * as path from \"path\"\n\nimport { Stage, IProgram } from \"../commands/types\"\nimport JestWorker from \"jest-worker\"\n\ntype ActivityTracker = any // TODO: Replace this with proper type once reporter is typed\n\ninterface IServer {\n  compiler: webpack.Compiler\n  listener: http.Server | https.Server\n  webpackActivity: ActivityTracker\n  cancelDevJSNotice: CancelExperimentNoticeCallbackOrUndefined\n  websocketManager: WebsocketManager\n  workerPool: JestWorker\n  webpackWatching: IWebpackWatchingPauseResume\n}\n\nexport interface IWebpackWatchingPauseResume extends webpack.Watching {\n  suspend: () => void\n  resume: () => void\n}\n\n// context seems to be public, but not documented API\n// see https://github.com/webpack/webpack-dev-middleware/issues/656\ntype PatchedWebpackDevMiddleware = WebpackDevMiddleware &\n  express.RequestHandler & {\n    context: {\n      watching: IWebpackWatchingPauseResume\n    }\n  }\n\nexport async function startServer(\n  program: IProgram,\n  app: Express,\n  workerPool: JestWorker = WorkerPool.create()\n): Promise<IServer> {\n  const directory = program.directory\n\n  const webpackActivity = report.activityTimer(`Building development bundle`, {\n    id: `webpack-develop`,\n  })\n  webpackActivity.start()\n\n  // Remove the following when merging GATSBY_EXPERIMENTAL_DEV_SSR\n  const directoryPath = withBasePath(directory)\n  const { buildHTML } = require(`../commands/build-html`)\n  const createIndexHtml = async (activity: ActivityTracker): Promise<void> => {\n    try {\n      await buildHTML({\n        program,\n        stage: Stage.DevelopHTML,\n        pagePaths: [`/`],\n        workerPool,\n        activity,\n      })\n    } catch (err) {\n      if (err.name !== `WebpackError`) {\n        report.panic(err)\n        return\n      }\n      report.panic(\n        report.stripIndent`\n          There was an error compiling the html.js component for the development server.\n          See our docs page on debugging HTML builds for help https://gatsby.dev/debug-html\n        `,\n        err\n      )\n    }\n  }\n  const indexHTMLActivity = report.phantomActivity(`building index.html`, {})\n\n  if (process.env.GATSBY_EXPERIMENTAL_DEV_SSR) {\n    const { buildRenderer } = require(`../commands/build-html`)\n    await buildRenderer(program, Stage.DevelopHTML)\n    const { initDevWorkerPool } = require(`./dev-ssr/render-dev-html`)\n    initDevWorkerPool()\n  } else {\n    indexHTMLActivity.start()\n\n    await createIndexHtml(indexHTMLActivity)\n\n    indexHTMLActivity.end()\n  }\n\n  const TWENTY_SECONDS = 20 * 1000\n  let cancelDevJSNotice: CancelExperimentNoticeCallbackOrUndefined\n  if (\n    process.env.gatsby_executing_command === `develop` &&\n    !process.env.GATSBY_EXPERIMENTAL_LAZY_DEVJS &&\n    !isCI()\n  ) {\n    cancelDevJSNotice = showExperimentNoticeAfterTimeout(\n      `LAZY_DEVJS`,\n      report.stripIndent(`\nYour local development experience is about to get better, faster, and stronger!\n\nYour friendly Gatsby maintainers detected your site takes longer than ideal to bundle your JavaScript. We're working right now to improve this.\n\nIf you're interested in trialing out one of these future improvements *today* which should make your local development experience faster, go ahead and run your site with LAZY_DEVJS enabled.\n\nGATSBY_EXPERIMENTAL_LAZY_DEVJS=true gatsby develop\n\nPlease do let us know how it goes (good, bad, or otherwise) at https://gatsby.dev/lazy-devjs-umbrella\n      `),\n      TWENTY_SECONDS\n    )\n  }\n\n  const devConfig = await webpackConfig(\n    program,\n    directory,\n    `develop`,\n    program.port,\n    { parentSpan: webpackActivity.span }\n  )\n\n  const compiler = webpack(devConfig)\n\n  if (process.env.GATSBY_EXPERIMENTAL_LAZY_DEVJS) {\n    const bodyParser = require(`body-parser`)\n    const { boundActionCreators } = require(`../redux/actions`)\n    const { createClientVisitedPage } = boundActionCreators\n    // Listen for the client marking a page as visited (meaning we need to\n    // compile its page component.\n    const chunkCalls = new Set()\n    app.post(`/___client-page-visited`, bodyParser.json(), (req, res, next) => {\n      if (req.body?.chunkName) {\n        // Ignore all but the first POST.\n        if (!chunkCalls.has(req.body.chunkName)) {\n          // Tell Gatsby there's a new page component to trigger it\n          // being added to the bundle.\n          createClientVisitedPage(req.body.chunkName)\n\n          // Tell Gatsby to rewrite the page data for the pages\n          // owned by this component to update it to say that\n          // its page component is now part of the dev bundle.\n          // The pages will be rewritten after the webpack compilation\n          // finishes.\n          //\n          // Set a timeout to ensure the webpack compile of the new page\n          // component triggered above has time to go through.\n          setTimeout(() => {\n            // Find the component page for this componentChunkName.\n            const pages = store.getState().pages\n            function getByChunkName(map, searchValue): void | string {\n              for (const [key, value] of map.entries()) {\n                if (value.componentChunkName === searchValue) return key\n              }\n\n              return undefined\n            }\n            const pageKey = getByChunkName(pages, req.body.chunkName)\n\n            if (pageKey) {\n              const page = pages.get(pageKey)\n              if (page) {\n                store.dispatch({\n                  type: `ADD_PENDING_TEMPLATE_DATA_WRITE`,\n                  payload: {\n                    pages: [\n                      {\n                        componentPath: page.component,\n                      },\n                    ],\n                  },\n                })\n              }\n            }\n            chunkCalls.add(req.body.chunkName)\n          }, 20)\n        }\n        res.send(`ok`)\n      } else {\n        next()\n      }\n    })\n  }\n\n  /**\n   * Set up the express app.\n   **/\n  app.use(compression())\n  app.use(telemetry.expressMiddleware(`DEVELOP`))\n  app.use(\n    webpackHotMiddleware(compiler, {\n      log: false,\n      path: `/__webpack_hmr`,\n      heartbeat: 10 * 1000,\n    })\n  )\n\n  app.use(cors())\n\n  /**\n   * Pattern matching all endpoints with graphql or graphiql with 1 or more leading underscores\n   */\n  const graphqlEndpoint = `/_+graphi?ql`\n\n  if (process.env.GATSBY_GRAPHQL_IDE === `playground`) {\n    app.get(\n      graphqlEndpoint,\n      graphqlPlayground({\n        endpoint: `/___graphql`,\n      }),\n      () => {}\n    )\n  } else {\n    graphiqlExplorer(app, {\n      graphqlEndpoint,\n    })\n  }\n\n  app.use(\n    graphqlEndpoint,\n    graphqlHTTP(\n      (): graphqlHTTP.OptionsData => {\n        const { schema, schemaCustomization } = store.getState()\n\n        if (!schemaCustomization.composer) {\n          throw new Error(\n            `A schema composer was not created in time. This is likely a gatsby bug. If you experienced this please create an issue.`\n          )\n        }\n        return {\n          schema,\n          graphiql: false,\n          extensions(): { [key: string]: unknown } {\n            return {\n              enableRefresh: process.env.ENABLE_GATSBY_REFRESH_ENDPOINT,\n              refreshToken: process.env.GATSBY_REFRESH_TOKEN,\n            }\n          },\n          context: withResolverContext({\n            schema,\n            schemaComposer: schemaCustomization.composer,\n            context: {},\n            customContext: schemaCustomization.context,\n          }),\n          customFormatErrorFn(err): unknown {\n            return {\n              ...formatError(err),\n              stack: err.stack ? err.stack.split(`\\n`) : [],\n            }\n          },\n        }\n      }\n    )\n  )\n\n  /**\n   * Refresh external data sources.\n   * This behavior is disabled by default, but the ENABLE_GATSBY_REFRESH_ENDPOINT env var enables it\n   * If no GATSBY_REFRESH_TOKEN env var is available, then no Authorization header is required\n   **/\n  const REFRESH_ENDPOINT = `/__refresh`\n  const refresh = async (req: express.Request): Promise<void> => {\n    emitter.emit(`WEBHOOK_RECEIVED`, {\n      webhookBody: req.body,\n    })\n  }\n  app.use(REFRESH_ENDPOINT, express.json())\n  app.post(REFRESH_ENDPOINT, (req, res) => {\n    const enableRefresh = process.env.ENABLE_GATSBY_REFRESH_ENDPOINT\n    const refreshToken = process.env.GATSBY_REFRESH_TOKEN\n    const authorizedRefresh =\n      !refreshToken || req.headers.authorization === refreshToken\n\n    if (enableRefresh && authorizedRefresh) {\n      refresh(req)\n    }\n    res.end()\n  })\n\n  app.get(`/__open-stack-frame-in-editor`, (req, res) => {\n    launchEditor(req.query.fileName, req.query.lineNumber)\n    res.end()\n  })\n\n  app.get(\n    `/page-data/:pagePath(*)/page-data.json`,\n    async (req, res, next): Promise<void> => {\n      const requestedPagePath = req.params.pagePath\n      if (!requestedPagePath) {\n        next()\n        return\n      }\n\n      const potentialPagePath = reverseFixedPagePath(requestedPagePath)\n      const page = findPageByPath(store.getState(), potentialPagePath, false)\n\n      if (page) {\n        try {\n          const pageData: IPageDataWithQueryResult = process.env\n            .GATSBY_EXPERIMENTAL_QUERY_ON_DEMAND\n            ? await getPageDataExperimental(page.path)\n            : await readPageData(\n                path.join(store.getState().program.directory, `public`),\n                page.path\n              )\n\n          res.status(200).send(pageData)\n          return\n        } catch (e) {\n          report.error(\n            `Error loading a result for the page query in \"${requestedPagePath}\" / \"${potentialPagePath}\". Query was not run and no cached result was found.`,\n            e\n          )\n        }\n      }\n\n      res.status(404).send({\n        path: potentialPagePath,\n      })\n    }\n  )\n\n  // Disable directory indexing i.e. serving index.html from a directory.\n  // This can lead to serving stale html files during development.\n  //\n  // We serve by default an empty index.html that sets up the dev environment.\n  app.use(developStatic(`public`, { index: false }))\n\n  const webpackDevMiddlewareInstance = (webpackDevMiddleware(compiler, {\n    logLevel: `silent`,\n    publicPath: devConfig.output.publicPath,\n    watchOptions: devConfig.devServer ? devConfig.devServer.watchOptions : null,\n    stats: `errors-only`,\n  }) as unknown) as PatchedWebpackDevMiddleware\n\n  app.use(webpackDevMiddlewareInstance)\n\n  // Expose access to app for advanced use cases\n  const { developMiddleware } = store.getState().config\n\n  if (developMiddleware) {\n    developMiddleware(app, program)\n  }\n\n  // Set up API proxy.\n  const { proxy } = store.getState().config\n  if (proxy) {\n    proxy.forEach(({ prefix, url }) => {\n      app.use(`${prefix}/*`, (req, res) => {\n        const proxiedUrl = url + req.originalUrl\n        const {\n          // remove `host` from copied headers\n          // eslint-disable-next-line @typescript-eslint/no-unused-vars\n          headers: { host, ...headers },\n          method,\n        } = req\n        req\n          .pipe(\n            got\n              .stream(proxiedUrl, { headers, method, decompress: false })\n              .on(`response`, response =>\n                res.writeHead(response.statusCode || 200, response.headers)\n              )\n              .on(`error`, (err, _, response) => {\n                if (response) {\n                  res.writeHead(response.statusCode || 400, response.headers)\n                } else {\n                  const message = `Error when trying to proxy request \"${req.originalUrl}\" to \"${proxiedUrl}\"`\n\n                  report.error(message, err)\n                  res.sendStatus(500)\n                }\n              })\n          )\n          .pipe(res)\n      })\n    }, cors())\n  }\n\n  await apiRunnerNode(`onCreateDevServer`, { app, deferNodeMutation: true })\n\n  // In case nothing before handled hot-update - send 404.\n  // This fixes \"Unexpected token < in JSON at position 0\" runtime\n  // errors after restarting development server and\n  // cause automatic hard refresh in the browser.\n  app.use(/.*\\.hot-update\\.json$/i, (_, res) => {\n    res.status(404).end()\n  })\n\n  // Render an HTML page and serve it.\n  if (process.env.GATSBY_EXPERIMENTAL_DEV_SSR) {\n    // Setup HTML route.\n    const { route } = require(`./dev-ssr/develop-html-route`)\n    route({ app, program, store })\n  }\n\n  app.use(async (req, res) => {\n    const fullUrl = req.protocol + `://` + req.get(`host`) + req.originalUrl\n    // This isn't used in development.\n    if (fullUrl.endsWith(`app-data.json`)) {\n      res.json({ webpackCompilationHash: `123` })\n      // If this gets here, it's a non-existant file so just send back 404.\n    } else if (fullUrl.endsWith(`.json`)) {\n      res.json({}).status(404)\n    } else {\n      if (process.env.GATSBY_EXPERIMENTAL_DEV_SSR) {\n        try {\n          const { renderDevHTML } = require(`./dev-ssr/render-dev-html`)\n          const renderResponse = await renderDevHTML({\n            path: `/dev-404-page/`,\n            // Let renderDevHTML figure it out.\n            page: undefined,\n            store,\n            htmlComponentRendererPath: `${program.directory}/public/render-page.js`,\n            directory: program.directory,\n          })\n          const status = process.env.GATSBY_EXPERIMENTAL_DEV_SSR ? 404 : 200\n          res.status(status).send(renderResponse)\n        } catch (e) {\n          report.error(e)\n          res.send(e).status(500)\n        }\n      } else {\n        res.sendFile(directoryPath(`public/index.html`), err => {\n          if (err) {\n            res.status(500).end()\n          }\n        })\n      }\n    }\n  })\n\n  /**\n   * Set up the HTTP server and socket.io.\n   **/\n  const server = new http.Server(app)\n\n  const socket = websocketManager.init({ server })\n\n  // hardcoded `localhost`, because host should match `target` we set\n  // in http proxy in `develop-proxy`\n  const listener = server.listen(program.port, `localhost`)\n\n  if (!process.env.GATSBY_EXPERIMENTAL_DEV_SSR) {\n    const chokidar = require(`chokidar`)\n    const { slash } = require(`gatsby-core-utils`)\n    // Register watcher that rebuilds index.html every time html.js changes.\n    const watchGlobs = [`src/html.js`, `plugins/**/gatsby-ssr.js`].map(path =>\n      slash(directoryPath(path))\n    )\n\n    chokidar.watch(watchGlobs).on(`change`, async () => {\n      await createIndexHtml(indexHTMLActivity)\n      // eslint-disable-next-line no-unused-expressions\n      socket?.to(`clients`).emit(`reload`)\n    })\n  }\n\n  return {\n    compiler,\n    listener,\n    webpackActivity,\n    cancelDevJSNotice,\n    websocketManager,\n    workerPool,\n    webpackWatching: webpackDevMiddlewareInstance.context.watching,\n  }\n}\n"],"file":"start-server.js"}